<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wappy üçâ Chat</title>
    
    <script>
        (function() {
            if (localStorage.getItem('theme') === 'dark' || 
                (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
        })();
    </script>
    
    <script src="/socket.io/socket.io.js"></script>
    <link rel="stylesheet" href="style.css">
    
    <style>
        /* === DEFAULT THEME === */
        body { 
            background-color: #E5DDD5; 
            background-image: url('https://user-images.githubusercontent.com/15075759/28719144-86dc0f70-73b1-11e7-911d-60d70fcded21.png'); 
            background-attachment: fixed;
            transition: background 0.5s ease; /* Smooth color change */
        }
        .dark body { background-color: #0b141a; background-image: url('https://bg.wpp.chat/d/dark.png'); }

        /* === NAYA: MOOD THEMES (Backgrounds) === */
        /* Happy: Sunny Yellow/Orange */
        body.theme-happy { 
            background-image: linear-gradient(120deg, #f6d365 0%, #fda085 100%) !important; 
        }
        /* Sad: Rainy Blue */
        body.theme-sad { 
            background-image: linear-gradient(to top, #30cfd0 0%, #330867 100%) !important; 
            color: white;
        }
        /* Angry: Intense Red/Purple */
        body.theme-angry { 
            background-image: linear-gradient(to right, #b91d73, #f953c6) !important; 
            color: white;
        }
        /* Love: Pink Hearts vibe */
        body.theme-love { 
            background-image: linear-gradient(to top, #ff9a9e 0%, #fecfef 99%, #fecfef 100%) !important; 
        }
        /* Cool: Fresh Cyan/Teal */
        body.theme-cool { 
            background-image: linear-gradient(120deg, #84fab0 0%, #8fd3f4 100%) !important; 
        }
        
        /* Bubble Styles (Standard) */
        .bubble { position: relative; max-width: 70%; padding: 8px 12px; border-radius: 8px; box-shadow: 0 1px 1px rgba(0,0,0,0.1); overflow-wrap: break-word; word-wrap: break-word; user-select: none; }
        .bubble-sender { background-color: #DCF8C6; align-self: flex-end; color: #0F172A; cursor: pointer; }
        .dark .bubble-sender { background-color: #005C4B; color: #E9EDEF; }
        .bubble-receiver { background-color: #FFFFFF; align-self: flex-start; color: #0F172A; cursor: pointer; }
        .dark .bubble-receiver { background-color: #202C33; color: #E9EDEF; }
        
        /* Mood specific adjustments (text readability) */
        body.theme-angry .bubble-receiver, body.theme-sad .bubble-receiver {
            background-color: rgba(255, 255, 255, 0.9); /* Thoda transparent taaki background dikhe */
        }
        
        .sender-name { font-size: 0.8rem; font-weight: 600; color: #00A884; margin-bottom: 2px; }
        .bubble-meta { font-size: 0.75rem; color: #6B7280; text-align: right; margin-top: 4px; }
        .dark .bubble-meta { color: #8696A0; }
        
        /* Context Menu & Other UI */
        #context-menu { position: absolute; background-color: white; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); z-index: 50; display: none; }
        .dark #context-menu { background-color: #202C33; }
        #context-menu button { display: block; width: 100%; padding: 12px 16px; background: none; border: none; text-align: left; color: #0F172A; font-size: 1rem; }
        .dark #context-menu button { color: #E9EDEF; }
        #reply-preview { padding: 8px 12px; background-color: #f0f2f5; border-bottom: 1px solid #e0e0e0; }
        .dark #reply-preview { background-color: #2a3942; border-bottom: 1px solid #374151; }
        
        /* Truth Badge */
        .truth-badge { font-size: 0.8rem; margin-right: 4px; display: none; }
        .bubble.is-truth .truth-badge { display: inline; }
        .bubble.is-truth { border: 2px solid #22c55e; } /* Green border for Truth Mode */
        
        .hidden { display: none; }
        .starred .star-icon { display: inline; color: #fbbf24; margin-right: 4px; }
    </style>
</head>
<body class="flex flex-col h-screen">

    <header class="bg-green-600 dark:bg-gray-800 text-white p-2 flex justify-between items-center shadow-md sticky top-0 z-10 bg-opacity-90 backdrop-blur-sm">
        <div class="flex items-center">
            <a href="/chats.html" class="mr-2 text-2xl p-1">‚Üê</a>
            <img id="friend-avatar" src="placeholder.jpg" class="w-9 h-9 rounded-full object-cover mr-3 border-2 border-white">
            <div>
                <h1 id="friend-name" class="text-lg font-bold">Loading...</h1>
                <span id="friend-status" class="text-sm font-light">...</span>
                <span id="friend-mood-icon" class="ml-2 text-lg"></span> 
            </div>
        </div>
        <div class="dropdown">
            <button id="menu-btn" class="p-2 rounded-full hover:bg-green-700 dark:hover:bg-gray-700">
                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path d="M10 6a2 2 0 110-4 2 2 0 010 4zM10 12a2 2 0 110-4 2 2 0 010 4zM10 18a2 2 0 110-4 2 2 0 010 4z"></path></svg>
            </button>
            <div id="menu-dropdown" class="dropdown-content hidden absolute right-0 top-full bg-white dark:bg-gray-800 shadow-lg rounded p-2 z-20">
                <a href="/logout" class="block p-2 hover:bg-gray-100 dark:hover:bg-gray-700 text-black dark:text-white no-underline">Logout</a>
                <a href="#" id="block-btn" class="block p-2 hover:bg-gray-100 dark:hover:bg-gray-700 text-black dark:text-white no-underline">Block User</a>
            </div>
        </div>
    </header>

    <ul id="messages" class="flex-1 p-4 overflow-y-auto space-y-3 flex flex-col">
        <li id="loading-spinner" class="hidden flex justify-center p-4">
             <div style="width: 30px; height: 30px; border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; animation: spin 1s linear infinite;"></div>
        </li>
    </ul>

    <div class="sticky bottom-0 bg-white dark:bg-gray-800 shadow-inner bg-opacity-90 backdrop-blur-sm">
        <div id="reply-preview" class="hidden">
            <div class="flex justify-between items-center p-2">
                <div class="reply-preview-content flex-1 border-l-4 border-green-500 pl-2">
                    <div id="reply-sender" class="font-bold text-green-600">Replying to...</div>
                    <div id="reply-text" class="text-gray-600 dark:text-gray-300 text-sm">...</div>
                </div>
                <button id="cancel-reply-btn" class="p-2 text-2xl">&times;</button>
            </div>
        </div>
    
        <form id="form" class="flex p-2 items-center">
            <button type="button" id="truth-mode-btn" class="p-2 text-xl text-gray-500 dark:text-gray-400 hover:text-green-500 transition-colors">
                <span>üîì</span>
            </button>
            
            <input id="input" autocomplete="off" class="flex-1 border rounded-full px-4 py-2 focus:outline-none focus:ring-2 focus:ring-green-400 bg-white dark:bg-gray-700 dark:text-gray-200 dark:border-gray-600" placeholder="Type a message..." />
            <button id="send-btn" class="bg-green-500 hover:bg-green-600 text-white font-bold p-3 rounded-full ml-2">
                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path d="M10.894 2.886l-7.05 4.935A1 1 0 003 8.76v.014l4.286 1.714a1 1 0 001.213-.865l.024-1.259 3.014-2.11a.5.5 0 01.604.604l-2.11 3.014-1.259.024a1 1 0 00-.865 1.213l1.714 4.286v.014a1 1 0 00.939.809l4.935-7.05a1 1 0 00-1.789-1.258z"></path></svg>
            </button>
        </form>
    </div>

    <div id="context-menu-overlay" class="hidden fixed inset-0 z-40"></div>
    <div id="context-menu">
        <button id="ctx-reply">Reply</button>
        <button id="ctx-star">Star</button>
        <button id="ctx-forward">Forward</button>
        <button id="ctx-copy">Copy</button>
        <button id="ctx-delete-me">Delete for me</button>
        <button id="ctx-delete-everyone">Delete for everyone</button>
    </div>
    <div id="toast"></div>
    <script>
        // === JAVASCRIPT (MOOD UPDATE) ===
        const socket = io();
        const form = document.getElementById('form');
        const input = document.getElementById('input');
        const messages = document.getElementById('messages');
        const friendNameHeader = document.getElementById('friend-name');
        const friendStatusHeader = document.getElementById('friend-status');
        const friendAvatarHeader = document.getElementById('friend-avatar');
        const friendMoodIcon = document.getElementById('friend-mood-icon'); // NAYA
        
        const menuBtn = document.getElementById('menu-btn');
        const menuDropdown = document.getElementById('menu-dropdown');
        const blockBtn = document.getElementById('block-btn');
        const toast = document.getElementById('toast');
        
        // Truth Mode
        const truthModeBtn = document.getElementById('truth-mode-btn');
        let isTruthModeActive = false;
        
        // Context & Reply
        const contextMenuOverlay = document.getElementById('context-menu-overlay');
        const contextMenu = document.getElementById('context-menu');
        const replyPreview = document.getElementById('reply-preview');
        
        let myEmail = '';
        let chatId = '';
        let isGroupChat = false;
        let isBlocked = false;
        let currentReplyTo = null;
        let currentContextMenuMsgId = null;
        let isLoading = true;

        const urlParams = new URLSearchParams(window.location.search);
        chatId = urlParams.get('id');
        if (!chatId) window.location.href = '/chats.html';
        isGroupChat = !chatId.includes('@');

        function showToast(message) {
            toast.textContent = message;
            toast.className = "show";
            setTimeout(() => { toast.className = toast.className.replace("show", ""); }, 3000);
        }

        // === NAYA: Mood UI Update Function ===
        function applyMoodTheme(mood) {
            // Pehle saare purane themes hatao
            document.body.classList.remove('theme-happy', 'theme-sad', 'theme-angry', 'theme-love', 'theme-cool');
            
            // Mood Icon aur Theme set karo
            let icon = '';
            if (mood && mood !== 'default') {
                document.body.classList.add(`theme-${mood}`);
                
                switch(mood) {
                    case 'happy': icon = 'üòä'; break;
                    case 'sad': icon = 'üòî'; break;
                    case 'angry': icon = 'üò°'; break;
                    case 'love': icon = 'üòç'; break;
                    case 'cool': icon = 'üòé'; break;
                }
                friendMoodIcon.textContent = icon;
            } else {
                friendMoodIcon.textContent = ''; // Default mein koi icon nahi
            }
        }

        async function loadChatData() {
            try {
                isLoading = true;
                const meRes = await fetch('/api/me');
                const me = await meRes.json();
                myEmail = me.email;

                const infoUrl = isGroupChat ? `/api/groupinfo/${chatId}` : `/api/userinfo/${chatId}`;
                const infoRes = await fetch(infoUrl);
                if (!infoRes.ok) throw new Error('Error');
                const chatInfo = await infoRes.json();

                friendNameHeader.textContent = chatInfo.displayName || chatInfo.groupName;
                
                // Avatar
                const avatarUrl = chatInfo.avatarUrl || chatInfo.groupAvatar;
                friendAvatarHeader.src = avatarUrl ? avatarUrl : `https://ui-avatars.com/api/?name=${(chatInfo.displayName || chatInfo.groupName).charAt(0)}&background=random&size=64`;

                if (isGroupChat) {
                    friendStatusHeader.textContent = `${chatInfo.members.length} members`;
                    blockBtn.style.display = 'none';
                } else {
                    friendStatusHeader.textContent = chatInfo.status === 'Online' ? 'Online' : 'Offline';
                    isBlocked = chatInfo.isBlocked;
                    updateBlockUI(isBlocked);
                    blockBtn.style.display = 'block';
                    
                    // === NAYA: Mood Apply Karo ===
                    console.log("Friend's Mood:", chatInfo.currentMood);
                    applyMoodTheme(chatInfo.currentMood);
                }

                socket.emit('join room', chatId);
                
                // Messages Load Karo
                const msgsRes = await fetch(`/api/messages/${chatId}`);
                const data = await msgsRes.json();
                messages.innerHTML = ''; // Clear spinner
                data.messages.forEach(msg => renderMessage(msg, false));
                messages.scrollTop = messages.scrollHeight;
                
                isLoading = false;

            } catch (error) {
                console.error(error);
                friendNameHeader.textContent = 'Error loading chat';
            }
        }

        // === Message Rendering (Standard) ===
        function renderMessage(msg, animate) {
            const item = document.createElement('li');
            const isSender = msg.senderEmail === myEmail;
            
            let bubbleClass = isSender ? 'bubble-sender' : 'bubble-receiver';
            if (msg.isStarred) bubbleClass += ' starred';
            if (msg.isTruthMode) bubbleClass += ' is-truth';
            
            // Truth Badge
            const badge = msg.isTruthMode ? '<span class="truth-badge">üü¢</span>' : '';
            const time = new Date(msg.timestamp).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            
            item.className = `flex ${isSender ? 'justify-end' : 'justify-start'} mb-2`;
            item.innerHTML = `
                <div class="bubble ${bubbleClass}" data-msg-id="${msg.messageId}">
                    ${isGroupChat && !isSender ? `<div class="sender-name">${msg.senderName}</div>` : ''}
                    <p class="m-0 ${msg.isDeleted ? 'deleted-message' : ''}">${msg.isDeleted ? 'Deleted message' : msg.text}</p>
                    <div class="bubble-meta">
                        ${badge} <span class="star-icon">‚≠ê</span> <span>${time}</span>
                    </div>
                </div>
            `;
            
            // Context Menu Events
            if (!msg.isDeleted) {
                const bubble = item.querySelector('.bubble');
                bubble.addEventListener('contextmenu', (e) => {
                    e.preventDefault();
                    openContextMenu(e, msg);
                });
            }
            messages.appendChild(item);
            if (animate) messages.scrollTop = messages.scrollHeight;
        }

        // === Truth Mode Toggle ===
        truthModeBtn.addEventListener('click', () => {
            isTruthModeActive = !isTruthModeActive;
            const icon = truthModeBtn.querySelector('span');
            if (isTruthModeActive) {
                icon.textContent = 'üîí';
                truthModeBtn.classList.add('text-green-500');
                showToast('Truth Mode ON');
            } else {
                icon.textContent = 'üîì';
                truthModeBtn.classList.remove('text-green-500');
                showToast('Truth Mode OFF');
            }
        });

        // === Sending Messages ===
        form.addEventListener('submit', (e) => {
            e.preventDefault();
            const text = input.value.trim();
            if (text && chatId) {
                const tempId = Date.now().toString();
                const msgData = {
                    messageId: tempId, senderEmail: myEmail, text: text,
                    timestamp: Date.now(), status: 'sending', isTruthMode: isTruthModeActive
                };
                renderMessage(msgData, true);
                socket.emit('send message', {
                    receiverId: chatId, text: text, isTruthMode: isTruthModeActive
                });
                input.value = '';
                
                // Reset Truth Mode
                if (isTruthModeActive) truthModeBtn.click();
            }
        });

        // === Listeners ===
        socket.on('new message', (msg) => {
            if (msg.senderEmail !== myEmail) renderMessage(msg, true);
        });

        // Menu & Context Logic
        function openContextMenu(e, msg) {
            currentContextMenuMsgId = msg.messageId;
            // Logic to show menu... (Simplified for brevity)
            contextMenu.style.display = 'block';
            contextMenu.style.left = (e.pageX - 50) + 'px';
            contextMenu.style.top = (e.pageY - 50) + 'px';
            contextMenuOverlay.classList.remove('hidden');
            
            // Hide delete if Truth Mode
            if (msg.isTruthMode) {
                document.getElementById('ctx-delete-me').style.display = 'none';
                document.getElementById('ctx-delete-everyone').style.display = 'none';
            } else {
                document.getElementById('ctx-delete-me').style.display = 'block';
            }
        }
        
        contextMenuOverlay.addEventListener('click', () => {
            contextMenu.style.display = 'none';
            contextMenuOverlay.classList.add('hidden');
        });
        
        menuBtn.addEventListener('click', () => {
            const d = document.getElementById('menu-dropdown');
            d.classList.toggle('hidden');
        });
        
        function updateBlockUI(blocked) {
             blockBtn.textContent = blocked ? 'Unblock' : 'Block';
             input.disabled = blocked;
        }

        loadChatData();
    </script>
</body>
</html>
