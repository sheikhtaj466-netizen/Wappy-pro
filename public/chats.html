<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chats üçâ Wappy</title>
    
    <script>
        (function() {
            if (localStorage.getItem('theme') === 'dark' || 
                (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
        })();
    </script>
    
    <script src="/socket.io/socket.io.js"></script>
    <link rel="stylesheet" href="style.css">
    
    <style>
        body { padding-bottom: 70px; }
        .dark body { background-color: #121212; }
        .bottom-nav { position: fixed; bottom: 0; left: 0; right: 0; z-index: 10; }
        .pinned { background-color: #f0f2f5; }
        .dark .pinned { background-color: #2a3942; }
        .header-search { background-color: #f0f2f5; }
        .dark .header-search { background-color: #202c33; }
        .fab { position: fixed; bottom: 80px; right: 20px; z-index: 15; box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
        .dropdown { position: relative; display: inline-block; }
        .dropdown-content { display: none; position: absolute; right: 0; top: 110%; background-color: white; min-width: 160px; box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2); z-index: 20; border-radius: 8px; }
        .dark .dropdown-content { background-color: #202C33; }
        .dropdown-content a { color: black; padding: 12px 16px; text-decoration: none; display: block; }
        .dark .dropdown-content a { color: #E9EDEF; }
        .dropdown-content a:hover { background-color: #f1f1f1; }
        .dark .dropdown-content a:hover { background-color: #182229; }
        
        /* Last message text */
        .last-message {
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .hidden {
            display: none;
        }
    </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900">

    <header class="bg-green-600 dark:bg-gray-800 text-white shadow-md sticky top-0 z-10">
        <div class="flex justify-between items-center p-3">
            <h1 class="text-2xl font-bold">üçâ Wappy</h1>
            <div class="flex items-center space-x-2">
                <a href="/profile.html">
                    <img id="header-avatar" src="placeholder.jpg" class="w-8 h-8 rounded-full object-cover border-2 border-white dark:border-gray-400">
                </a>
                <div class="dropdown">
                    <button id="menu-btn" class="p-2 rounded-full hover:bg-green-700 dark:hover:bg-gray-700">
                        <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path d="M10 6a2 2 0 110-4 2 2 0 010 4zM10 12a2 2 0 110-4 2 2 0 010 4zM10 18a2 2 0 110-4 2 2 0 010 4z"></path></svg>
                    </button>
                    <div id="menu-dropdown" class="dropdown-content">
                        <a href="/create-group.html">New Group</a> <a href="/profile.html">Settings</a>
                        <a href="/logout">Logout</a>
                    </div>
                </div>
            </div>
        </div>
        <div class="p-2">
            <input type="text" id="search-chats" placeholder="Search chats..." class="w-full px-4 py-2 rounded-full text-gray-800 dark:text-white header-search focus:outline-none focus:ring-2 focus:ring-green-300">
        </div>
    </header>

    <div class="container mx-auto max-w-lg">
        
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md overflow-hidden">
            <div id="chats-list">
                <p id="loading-text" class="text-gray-500 dark:text-gray-400 p-6">Loading your chats...</p>
                <div id="skeleton-loader" class="hidden">
                    <div class="flex items-center p-4 border-b dark:border-gray-700 animate-pulse">
                        <div class="w-12 h-12 rounded-full bg-gray-300 dark:bg-gray-700 mr-4"></div>
                        <div class="flex-1">
                            <div class="h-5 bg-gray-300 dark:bg-gray-700 rounded w-1/2 mb-2"></div>
                            <div class="h-3 bg-gray-300 dark:bg-gray-700 rounded w-1/4"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <button id="new-chat-fab" class="fab bg-green-500 hover:bg-green-600 text-white w-14 h-14 rounded-full flex items-center justify-center">
        <svg class="w-7 h-7" fill="currentColor" viewBox="0 0 24 24"><path d="M20 2H4c-1.103 0-2 .897-2 2v18l4-4h14c1.103 0 2-.897 2-2V4c0-1.103-.897-2-2-2zm-3 9h-4v4h-2v-4H7V9h4V5h2v4h4v2z"></path></svg>
    </button>
    
    <footer class="bottom-nav flex justify-around bg-white dark:bg-gray-800 shadow-md border-t dark:border-gray-700 p-2">
        <a href="/chats.html" class="flex flex-col items-center text-green-600 dark:text-green-400 p-2"> <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24"><path d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 5.523-4.477 10-10 10S1 17.523 1 12 5.477 2 11 2s10 4.477 10 10z"></path></svg>
            <span class="text-xs">Chats</span>
        </a>
        <a href="/home.html" class="flex flex-col items-center text-gray-500 dark:text-gray-400 p-2"> 
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M17 2H7C5.897 2 5 2.897 5 4v16c0 1.103.897 2 2 2h10c1.103 0 2-.897 2-2V4C19 2.897 18.103 2 17 2zM7 18V6h10v12H7zm5-9c-1.104 0-2 .896-2 2s.896 2 2 2 2-.896 2-2-.896-2-2-2z"></path></svg>
            <span class="text-xs">Contacts</span>
        </a>
        <a href="/profile.html" class="flex flex-col items-center text-gray-500 dark:text-gray-400 p-2">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg>
            <span class="text-xs">Profile</span>
        </a>
    </footer>

    <div id="toast" class="hidden fixed bottom-20 left-1/2 -translate-x-1/2 bg-gray-800 text-white px-4 py-2 rounded-lg shadow-lg transition-opacity duration-300 z-30"></div>
    <script>
        const socket = io();
        const chatsListDiv = document.getElementById('chats-list');
        const loadingText = document.getElementById('loading-text');
        const skeletonLoader = document.getElementById('skeleton-loader');
        const toast = document.getElementById('toast');
        const headerAvatar = document.getElementById('header-avatar');
        const menuBtn = document.getElementById('menu-btn');
        const menuDropdown = document.getElementById('menu-dropdown');
        const newChatFab = document.getElementById('new-chat-fab');
        const searchInput = document.getElementById('search-chats');
        let myEmail = '';
        let searchDebounceTimer;

        function showToast(message) {
            toast.textContent = message;
            toast.classList.remove('hidden');
            toast.classList.add('opacity-100');
            setTimeout(() => { 
                toast.classList.remove('opacity-100');
                toast.classList.add('hidden');
            }, 3000);
        }
        
        function formatTime(timestamp) {
            const date = new Date(timestamp);
            return date.toLocaleTimeString('en-US', { hour: 'numeric', minute: 'numeric', hour12: true });
        }
        function getTicks(msg) {
            if (msg.senderEmail !== myEmail) return ''; // Dost ke message par tick nahi
            if (msg.status === 'seen') { return '<span class="text-blue-500 ml-1">‚úì‚úì</span>'; }
            if (msg.status === 'delivered') { return '<span class="text-gray-500 dark:text-gray-400 ml-1">‚úì‚úì</span>'; }
            return '<span class="text-gray-500 dark:text-gray-400 ml-1">‚úì</span>';
        }


        async function loadChats(searchQuery = '') {
            loadingText.style.display = 'none';
            skeletonLoader.style.display = 'block'; 

            try {
                if (!searchQuery) {
                    const meResponse = await fetch('/api/me');
                    const me = await meResponse.json();
                    myEmail = me.email; // myEmail ko global set karo
                    if (me.avatarUrl) {
                        headerAvatar.src = me.avatarUrl;
                    } else {
                        headerAvatar.src = `https://ui-avatars.com/api/?name=${me.displayName.charAt(0)}&background=random&size=32`;
                    }
                }

                const response = await fetch(`/api/chats?q=${searchQuery}`);
                const chats = await response.json();
                
                skeletonLoader.style.display = 'none'; 
                chatsListDiv.innerHTML = ''; 

                if (chats.length === 0) {
                    if (searchQuery) {
                        chatsListDiv.innerHTML = `<p class="text-gray-500 dark:text-gray-400 p-6">No chats found matching "${searchQuery}".</p>`;
                    } else {
                        chatsListDiv.innerHTML = '<p class="text-gray-500 dark:text-gray-400 p-6">No chats yet. Start a conversation from your contacts list.</p>';
                    }
                    return;
                }
                
                chats.forEach(renderChat);

            } catch (error) {
                console.error('Error loading chats:', error);
                skeletonLoader.style.display = 'none';
                chatsListDiv.innerHTML = '<p class="text-red-500 dark:text-red-400 p-6">Could not load chats.</p>';
            }
        }
        
        function renderChat(chat) {
            const chatEl = document.createElement('a'); 
            
            // NAYA: Link ab /chat.html?id=... (ya toh email ya group-id)
            chatEl.href = `/chat.html?id=${chat.id}`; 
            
            chatEl.className = `flex items-center p-4 border-b dark:border-gray-700 no-underline ${chat.isPinned ? 'pinned dark:pinned' : 'hover:bg-gray-100 dark:hover:bg-gray-700'}`;
            
            const avatarSrc = chat.avatarUrl 
                ? chat.avatarUrl 
                : `https://ui-avatars.com/api/?name=${chat.nickname.charAt(0)}&background=random&size=64`;
            
            // NAYA: Agar group hai, toh "You:" nahi dikhayenge (jab tak hum sender ka naam nahi add karte)
            const lastMessageText = (chat.senderEmail === myEmail && !chat.isGroup) 
                ? `You: ${chat.text}` 
                : chat.text;

            chatEl.innerHTML = `
                <img src="${avatarSrc}" alt="Avatar" class="w-12 h-12 rounded-full object-cover mr-4">
                <div class="flex-1 overflow-hidden">
                    <div class="flex justify-between items-center">
                        <span class="text-lg text-gray-800 dark:text-white font-medium">${chat.nickname}</span>
                        <span class="text-xs text-gray-500 dark:text-gray-400">${formatTime(chat.timestamp)}</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <p class="last-message text-sm text-gray-500 dark:text-gray-400">
                            ${getTicks(chat)} ${lastMessageText}
                        </p>
                        ${chat.isPinned ? 'üìå' : ''}
                    </div>
                </div>
            `;
            chatsListDiv.appendChild(chatEl);
        }
        
        window.addEventListener('DOMContentLoaded', () => loadChats());

        menuBtn.addEventListener('click', () => {
            menuDropdown.style.display = (menuDropdown.style.display === 'block') ? 'none' : 'block';
        });
        window.addEventListener('click', (e) => {
            if (!menuBtn.contains(e.target) && !menuDropdown.contains(e.target)) {
                menuDropdown.style.display = 'none';
            }
        });
        
        newChatFab.addEventListener('click', () => {
            window.location.href = '/home.html';
        });

        searchInput.addEventListener('input', (e) => {
            clearTimeout(searchDebounceTimer);
            const query = e.target.value;
            searchDebounceTimer = setTimeout(() => {
                loadChats(query);
            }, 300);
        });

        // Real-time updates
        socket.on('new chat message', (messageData) => {
            loadChats(searchInput.value);
        });
        socket.on('chat list update', () => {
            loadChats(searchInput.value);
        });
        socket.on('friend status', (data) => {
            // (Isko Kadam 31 mein fix karenge)
        });
    </script>
</body>
</html>
